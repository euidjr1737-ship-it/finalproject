# app.py
import streamlit as st
import math
import random

st.set_page_config(page_title="MBTI Finder & ì´ìƒí˜• ë¶„ì„ê¸°", layout="centered")

# ----------------------------
# ë°ì´í„°: MBTI ì„¤ëª… (ê°„ë‹¨ ì˜ˆì‹œ)
# ----------------------------
MBTI_DATA = {
    "INTJ": {
        "desc": "ì „ëµê°€í˜•: ë¶„ì„ì ì´ê³  ê³„íšì ì´ë©° ë‚´í–¥ì .",
        "strengths": ["ì „ëµì  ì‚¬ê³ ", "ë…ë¦½ì ", "ë¬¸ì œ í•´ê²° ëŠ¥ë ¥"],
        "weaknesses": ["ê°ì • í‘œí˜„ ë¶€ì¡±", "ìœµí†µì„± ë¶€ì¡±"],
        "jobs": ["ì—°êµ¬ì›", "ë°ì´í„° ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸", "ì „ëµ ì»¨ì„¤í„´íŠ¸"],
        "celebrity": "ì—˜ë¡  ë¨¸ìŠ¤í¬(ì˜ˆì‹œ)",
        "meme": "ë‚˜ëŠ” ê³„íšì´ ìˆë‹¤... ê·¸ë¦¬ê³  ë” ë§ì€ ê³„íšì´ ìˆë‹¤."
    },
    "ENTP": {
        "desc": "ë°œëª…ê°€í˜•: ì•„ì´ë””ì–´ê°€ ë„˜ì¹˜ê³  í† ë¡ ì„ ì¦ê¸´ë‹¤.",
        "strengths": ["ì°½ì˜ì„±", "ì¦‰í¥ë ¥", "í† ë¡  ëŠ¥ë ¥"],
        "weaknesses": ["ì§‘ì¤‘ ì§€ì† ì–´ë ¤ì›€", "ì™„ì„±ë„ ë‚®ìŒ"],
        "jobs": ["ìŠ¤íƒ€íŠ¸ì—… ì°½ì—…ê°€", "ë§ˆì¼€í„°", "ê¸°íšì"],
        "celebrity": "ë¦¬ì²˜ë“œ ë¸ŒëœìŠ¨(ì˜ˆì‹œ)",
        "meme": "ë˜ ë‹¤ë¥¸ ì•„ì´ë””ì–´? ë‹¹ì—°í•˜ì§€."
    },
    # (ê°„ë‹¨í™”ë¥¼ ìœ„í•´ ëŒ€í‘œ ë‘ íƒ€ì…ë§Œ ë„£ì—ˆìŒ â€” í•„ìš”í•˜ë©´ ë” ì¶”ê°€)
}

# ê¸°ë³¸: ëª¨ë“  ì¡°í•© ì—†ìœ¼ë©´ 'ê¸°ë³¸ ì„¤ëª…'
def get_mbti_info(mbti):
    return MBTI_DATA.get(mbti, {
        "desc": "ì•„ì§ ë°ì´í„° ì—†ìŒ(ì˜ˆì‹œ ë°ì´í„°ë§Œ í¬í•¨).",
        "strengths": ["ì•Œ ìˆ˜ ì—†ìŒ"],
        "weaknesses": ["ì•Œ ìˆ˜ ì—†ìŒ"],
        "jobs": ["ë‹¤ì–‘í•œ ì§ì—… ì í•©"],
        "celebrity": "í•´ë‹¹ ì—†ìŒ",
        "meme": "ê·¸ ìœ í˜•ì˜ ë°ˆì´ ì—†ìŒ..."
    })

# ----------------------------
# ë°ì´í„°: 20ê°œ ìºë¦­í„° (ì˜ˆì‹œ ì¶•ì•½íŒ)
# traits: [í„¸ë§ìŒ, ë¶€ë“œëŸ¬ì›€, ì¹´ë¦¬ìŠ¤ë§ˆ, ì•ˆì •ê°] (0-100)
# ----------------------------
CHARACTERS = [
    {"name": "ë£¨ë‚˜", "traits": [70, 80, 40, 60],
     "desc": "ë”°ëœ»í•˜ê³  í¬ê·¼í•œ ì¡´ì¬. ì†Œì†Œí•œ ì•ˆì •ê°ì„ ì¤€ë‹¤.",
     "strengths": ["ì• ì •í‘œí˜„", "ë°°ë ¤ì‹¬"]},
    {"name": "ì¹´ì´", "traits": [20, 40, 90, 50],
     "desc": "ì¹´ë¦¬ìŠ¤ë§ˆ ë„˜ì¹˜ê³  ì£¼ë„ì ì¸ íƒ€ì….",
     "strengths": ["ë¦¬ë”ì‹­", "ê²°ë‹¨ë ¥"]},
    {"name": "ë¯¸ì˜¤", "traits": [50, 90, 30, 80],
     "desc": "ì„¸ì‹¬í•˜ê³  í¬ê·¼í•œ ì´ë¯¸ì§€, ë¯¿ìŒì§ìŠ¤ëŸ¬ì›€.",
     "strengths": ["ì‹ ë¢°ê°", "ê³µê° ëŠ¥ë ¥"]},
    {"name": "ì œë¡œ", "traits": [10, 30, 95, 20],
     "desc": "ì°¨ê°‘ì§€ë§Œ ë§¤ë ¥ì ì¸ ì¹´ë¦¬ìŠ¤ë§ˆí˜•.",
     "strengths": ["ë…ë¦½ì„±", "ì••ë„ì  ì¡´ì¬ê°"]},
    {"name": "ë²¨ë¼", "traits": [85, 70, 20, 65],
     "desc": "ì• êµ ë§ê³  ë¶™ì„ì„± ì¢‹ì€ íƒ€ì….",
     "strengths": ["ì¹œí™”ë ¥", "ë‚™ì²œì„±"]},
    {"name": "ì†”", "traits": [30, 50, 60, 90],
     "desc": "ì°¨ë¶„í•˜ê³  ì•ˆì •ì ì¸ ë³´í˜¸ìí˜•.",
     "strengths": ["ì‹ ë¢°ì„±", "ì±…ì„ê°"]},
    {"name": "ì—ì´ë“ ", "traits": [40, 60, 70, 40],
     "desc": "ì ë‹¹í•œ ì¹´ë¦¬ìŠ¤ë§ˆì™€ ë¶€ë“œëŸ¬ì›€ì„ ê°€ì§„ ê· í˜•í˜•.",
     "strengths": ["ê· í˜•ê°", "ìœµí†µì„±"]},
    {"name": "ë¦°", "traits": [60, 85, 35, 55],
     "desc": "ë”°ëœ»í•˜ê³  ê°ì„±ì ì¸ ì˜ˆìˆ ê°€í˜•.",
     "strengths": ["ê°ì„±í‘œí˜„", "ì°½ì˜ì„±"]},
    {"name": "ì˜¤ìŠ¤ì¹´", "traits": [25, 35, 85, 45],
     "desc": "ì¿¨í•˜ê³  ê°•ë ¬í•œ ì´ë¯¸ì§€.",
     "strengths": ["ì¹´ë¦¬ìŠ¤ë§ˆ", "ë…ë¦½ì‹¬"]},
    {"name": "í•˜ëŠ˜", "traits": [50, 50, 50, 50],
     "desc": "ë¬´ë‚œí•˜ê³  ë°¸ëŸ°ìŠ¤ ì¢‹ì€ íƒ€ì….",
     "strengths": ["ì ì‘ë ¥", "ê· í˜•"]},
    # 10ê°œë§Œ ì˜ˆì‹œë¡œ ì±„ì›Œë’€ìŒ. ì‹¤ì œë¡œëŠ” 20ê°œ ì •ë„ ë” ì¶”ê°€í•˜ë©´ ì¢‹ìŒ.
]

# ----------------------------
# ë„êµ¬ í•¨ìˆ˜: MBTI ê³„ì‚°
# ë°©ì‹: 4ê°œ ì¶• ê°ê° 0-100 ìŠ¬ë¼ì´ë” (ë†’ì„ìˆ˜ë¡ ì™¼ìª½ ì„±í–¥)
# ì˜ˆ: E vs I -> E ì ìˆ˜ slider (0 ë‚´í–¥ ~ 100 ì™¸í–¥)
# ê¸°ì¤€: 50 ì´ìƒì´ë©´ ì™¼ìª½(E) ì•„ë‹ˆë©´ I
# ----------------------------
def calc_mbti(e_score, n_score, t_score, j_score):
    letters = []
    letters.append("E" if e_score >= 50 else "I")
    letters.append("N" if n_score >= 50 else "S")
    letters.append("T" if t_score >= 50 else "F")
    letters.append("J" if j_score >= 50 else "P")
    mbti = "".join(letters)
    # í¼ì„¼íŠ¸ í‘œí˜„: ê° ì¶•ì—ì„œ í•´ë‹¹ í¸í–¥ì˜ ì ˆëŒ€ê°’
    percents = {
        "E_percent": e_score,
        "N_percent": n_score,
        "T_percent": t_score,
        "J_percent": j_score
    }
    return mbti, percents

# ----------------------------
# ë„êµ¬ í•¨ìˆ˜: kNN (k=1) - ìœ í´ë¦¬ë“œ ê±°ë¦¬
# ----------------------------
def find_nearest_character(user_traits):
    best = None
    best_dist = None
    for ch in CHARACTERS:
        dist = math.sqrt(sum((u - v) ** 2 for u, v in zip(user_traits, ch["traits"])))
        if best_dist is None or dist < best_dist:
            best_dist = dist
            best = ch
    return best, best_dist

# ----------------------------
# UI
# ----------------------------
st.title("MBTI Finder & ì´ìƒí˜• ë¶„ì„ê¸° â€” í˜• ì „ìš© ë²„ì „")
st.write("ë‘˜ ì¤‘ í•˜ë‚˜ ê³¨ë¼. êµìˆ˜ë‹˜í•œí…Œ ë³´ì—¬ì¤˜ë„ ì°½í”¼í•˜ì§€ ì•Šê²Œ ì •ë¦¬í•´ë†¨ìŒ.")

app_mode = st.sidebar.selectbox("ëª¨ë“œ ì„ íƒ", ["MBTI Finder", "ì´ìƒí˜• ë¶„ì„ê¸°"])

if app_mode == "MBTI Finder":
    st.header("ğŸ§  MBTI Finder")
    st.write("ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì ˆí•´ì„œ ë„¤ ì„±í–¥ì„ ì…ë ¥í•´. 0-100 (ë†’ì„ìˆ˜ë¡ ì™¼ìª½ ì„±í–¥)")

    e_score = st.slider("ì™¸í–¥ì„±(E) â† 0 (ë‚´í–¥) ... 100 (ì™¸í–¥) â†’", min_value=0, max_value=100, value=45)
    n_score = st.slider("ì§ê´€(N) â† 0 (ê°ê°) ... 100 (ì§ê´€) â†’", min_value=0, max_value=100, value=55)
    t_score = st.slider("ì‚¬ê³ (T) â† 0 (ê°ì •) ... 100 (ì‚¬ê³ ) â†’", min_value=0, max_value=100, value=50)
    j_score = st.slider("ê³„íš(J) â† 0 (ì¦‰í¥) ... 100 (ê³„íš) â†’", min_value=0, max_value=100, value=60)

    if st.button("ê²°ê³¼ ë³´ê¸°"):
        mbti, perc = calc_mbti(e_score, n_score, t_score, j_score)
        info = get_mbti_info(mbti)

        st.subheader(f"ì˜ˆìƒ MBTI: {mbti}")
        st.write(info["desc"])
        st.write("**ê°•ì **: " + ", ".join(info["strengths"]))
        st.write("**ì•½ì **: " + ", ".join(info["weaknesses"]))
        st.write("**ì¶”ì²œ ì§ì—…**: " + ", ".join(info["jobs"]))
        st.write("**í•´ë‹¹ ìœ í˜• ì—°ì˜ˆì¸(ì˜ˆì‹œ)**: " + info["celebrity"])
        st.markdown("---")
        st.write("**ì„¸ë¶€ ì ìˆ˜(0-100)**")
        st.write(f"E ì ìˆ˜: {perc['E_percent']:.0f} / N ì ìˆ˜: {perc['N_percent']:.0f} / T ì ìˆ˜: {perc['T_percent']:.0f} / J ì ìˆ˜: {perc['J_percent']:.0f}")

        st.markdown("---")
        st.write("**ì¬ë¯¸ìˆëŠ” ë°ˆ**")
        # ë°ˆ ìƒ˜í”Œ
        memes = [
            "â€œì•„ë‹ˆ.. ê·¸ê±° ë‚´ ìŠ¤íƒ€ì¼ì¸ë° ì™œ ë‚´ê°€ ëª¨ë¥´ëŠ” ê±°ì•¼?â€",
            "â€œë‚´ ê³„íš: 1) ê³„íš ì„¸ìš°ê¸° 2) ê³„íš ì„¸ìš°ê¸° 3) ê³„íš ì„¸ìš°ê¸°â€",
            "â€œê°ì •ì€ ë’¤ë¡œ ë¯¸ë¤„ë„ ë¼. ë¬¸ì œëŠ” ë¯¸ë¤„ì§„ ê°ì •ì´ í„°ì§ˆ ë•Œ.â€",
            "â€œíŒ€ íšŒì˜ ìš”ì•½: ì•„ì´ë””ì–´ 100ê°œ, ì‹¤í–‰ 0ê°œ.â€"
        ]
        st.info(random.choice(memes))

        st.success("êµìˆ˜ë‹˜: 'ë°ì´í„° ë“œë¦¬ë¸ ì ‘ê·¼ ì˜í–ˆë„¤.' (ë‚´ ë§ ì•„ë‹˜, ë„ˆ ë§ì´ ë§ì•„.)")

elif app_mode == "ì´ìƒí˜• ë¶„ì„ê¸°":
    st.header("ğŸ’˜ ì´ìƒí˜• ë¶„ì„ê¸° (ê°„ë‹¨ kNN)")
    st.write("ë„¤ê°€ ì›í•˜ëŠ” 4ê°€ì§€ ì†ì„±ì„ ìŠ¬ë¼ì´ë”ë¡œ ì…ë ¥í•˜ë©´, ì €ì¥ëœ ìºë¦­í„° ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ìºë¦­í„°ë¥¼ ì°¾ì•„ì¤Œ.")

    t_fur = st.slider("í„¸ì´ ë§ì€ ì •ë„", 0, 100, 50)
    t_soft = st.slider("ë¶€ë“œëŸ¬ì›€", 0, 100, 60)
    t_char = st.slider("ì¹´ë¦¬ìŠ¤ë§ˆ", 0, 100, 50)
    t_safe = st.slider("ì•ˆì •ê°", 0, 100, 50)

    if st.button("ì¶”ì²œ ë°›ê¸°"):
        user_traits = [t_fur, t_soft, t_char, t_safe]
        best, dist = find_nearest_character(user_traits)
        st.subheader(f"ì¶”ì²œ ìºë¦­í„°: {best['name']}")
        st.write(best["desc"])
        st.write("**ê°•ì **: " + ", ".join(best["strengths"]))
        st.write(f"ìœ ì‚¬ë„ ê±°ë¦¬(ì‘ì„ìˆ˜ë¡ ìœ ì‚¬): {dist:.2f}")

        # ê·œì¹™ ê¸°ë°˜ ë§¤ì¹­ ì„¤ëª…
        st.markdown("---")
        st.write("**í˜•ì´ ì™œ ì´ ìºë¦­í„°ì™€ ì˜ ë§ëŠ”ì§€(ê·œì¹™ ê¸°ë°˜ ë¶„ì„)**")
        reasons = []
        trait_names = ["í„¸ë§ìŒ", "ë¶€ë“œëŸ¬ì›€", "ì¹´ë¦¬ìŠ¤ë§ˆ", "ì•ˆì •ê°"]
        for i, (u, v) in enumerate(zip(user_traits, best["traits"])):
            diff = abs(u - v)
            if diff <= 10:
                reasons.append(f"- {trait_names[i]}: ê±°ì˜ ì¼ì¹˜ ({u} vs {v}) â€” *êµ‰ì¥íˆ ì˜ ë§ìŒ*")
            elif diff <= 25:
                reasons.append(f"- {trait_names[i]}: ë¹„ìŠ·í•œ í¸ ({u} vs {v}) â€” *ë³´ì™„ ê°€ëŠ¥*")
            else:
                reasons.append(f"- {trait_names[i]}: ì°¨ì´ í¼ ({u} vs {v}) â€” *ë‹¤ë¥¸ ì ì´ ë§¤ë ¥ í¬ì¸íŠ¸ì¼ ìˆ˜ ìˆìŒ*")
        for r in reasons:
            st.write(r)

        st.markdown("---")
        st.write("**êµìˆ˜ë‹˜ í”„ë ˆì  í…Œì´ì…˜ìš© í•œ ì¤„**")
        st.write(f"> ì‚¬ìš©ìëŠ” ì„ íƒí•œ 4ì°¨ì› ì„ í˜¸ë„(í„¸:{t_fur}, ë¶€ë“œëŸ¬ì›€:{t_soft}, ì¹´ë¦¬ìŠ¤ë§ˆ:{t_char}, ì•ˆì •ê°:{t_safe})ë¥¼ ê¸°ë°˜ìœ¼ë¡œ '{best['name']}'ì„ ì¶”ì²œë°›ì•˜ìŠµë‹ˆë‹¤. (ë‹¨ìˆœ kNN ë°©ì‹)")

        st.info("ì°¸ê³ : ë°ì´í„°ëŠ” ë¡œì»¬ dictë¡œ ì €ì¥ë˜ì–´ ìˆì–´ API í•„ìš” ì—†ìŒ. ë” ë§ì€ ìºë¦­í„°ë¥¼ ì¶”ê°€í•˜ë©´ ì •í™•ë„ê°€ ì˜¬ë¼ê°.")

# í•˜ë‹¨: ë„ì›€ë§ ë° í™•ì¥ ì œì•ˆ
st.sidebar.markdown("---")
st.sidebar.write("í™•ì¥ ì•„ì´ë””ì–´:")
st.sidebar.write("- MBTI ë°ì´í„°ë² ì´ìŠ¤ í™•ì¥ (16ìœ í˜• ëª¨ë‘)")
st.sidebar.write("- ìºë¦­í„° 20~50ê°œë¡œ ëŠ˜ë¦¬ê³  ê°€ì¤‘ì¹˜ ì„¤ì • ì¶”ê°€")
st.sidebar.write("- k>1 íˆ¬í‘œ ë°©ì‹, í‘œì¤€í™” (z-score) ì ìš©")
st.sidebar.write("- ê²°ê³¼ë¥¼ PDFë¡œ ì €ì¥(ë³´ê³ ì„œ ì œì¶œìš©)")

st.sidebar.markdown("Made for: í˜• â€” Streamlit ê³¼ì œìš© ê¹”ë”í•œ ë°ëª¨")
